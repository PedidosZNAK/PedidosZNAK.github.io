<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pedidos Tienda</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    input,
    select {
      padding: 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
    }
    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #333;
      color: white;
    }
    input[type="number"] {
      width: 60px;
      padding: 5px;
    }
    button {
      background-color: #28a745;
      color: white;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #218838;
    }
    #status-message {
      text-align: center;
      margin-bottom: 10px;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom:10px;">
    <img
      id="logo-img"
      src="https://znakminimarket.com/wp-content/uploads/2023/06/logo-znak-02.png"
      alt="Logo"
      style="max-height: 80px"
    />
  </div>

  <h1>Pedidos Tienda</h1>

  <div id="status-message"></div>

  <div class="controls">
    <input type="text" id="storeName" placeholder="Nombre de la tienda" />
    <input type="text" id="searchBox" placeholder="Buscar producto" />
    <select id="providerFilter">
      <option value="">Todos los proveedores</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th>Proveedor</th>
        <th>Precio Unitario</th>
        <th>Cantidad</th>
      </tr>
    </thead>
    <tbody id="product-table"></tbody>
  </table>

  <div style="text-align:center;">
    <button onclick="generarPDF()">Generar PDF</button>
  </div>

  <script>
    const logoUrl = "https://znakminimarket.com/wp-content/uploads/2023/06/logo-znak-02.png";
    let productos = [];

    const tabla = document.getElementById("product-table");
    const searchBox = document.getElementById("searchBox");
    const providerFilter = document.getElementById("providerFilter");
    const statusMessage = document.getElementById("status-message");

    const catalogoUrl = "https://raw.githubusercontent.com/PedidosZNAK/CatalogoZNAK/main/CATALOGO%20ZNAK%20JSON.json";

    async function cargarCatalogo() {
      try {
        const res = await fetch(catalogoUrl);
        if (!res.ok) throw new Error("No se pudo cargar el catálogo");
        const json = await res.json();
        productos = json.data; // Asegúrate que la propiedad data exista
        console.log("Productos cargados:", productos);
        if (!productos || productos.length === 0) {
          statusMessage.textContent = "El catálogo está vacío o no se pudo cargar.";
          return;
        } else {
          statusMessage.textContent = "";
        }
        cargarProveedores();
        mostrarProductos();
      } catch (error) {
        statusMessage.textContent = "Error al cargar el catálogo. Revisa consola.";
        console.error(error);
      }
    }

    function cargarProveedores() {
      const proveedoresUnicos = [
        ...new Set(productos.map((p) => p.proveedor)),
      ];
      providerFilter.innerHTML = <option value="">Todos los proveedores</option>;
      proveedoresUnicos.forEach((prov) => {
        providerFilter.innerHTML += <option value="${prov}">${prov}</option>;
      });
    }

    function mostrarProductos() {
      const searchTerm = searchBox.value.toLowerCase();
      const filtroProveedor = providerFilter.value;
      tabla.innerHTML = "";

      productos.forEach((p, i) => {
        if (
          (p.nombre.toLowerCase().includes(searchTerm) || searchTerm === "") &&
          (filtroProveedor === "" || p.proveedor === filtroProveedor)
        ) {
          tabla.innerHTML += `
            <tr>
              <td>${p.nombre}</td>
              <td>${p.proveedor}</td>
              <td>$${p.precio}</td>
              <td><input type="number" id="cant-${i}" min="0" value="0"></td>
            </tr>
          `;
        }
      });

      if (tabla.innerHTML === "") {
        tabla.innerHTML = <tr><td colspan="4">No hay productos para mostrar.</td></tr>;
      }
    }

    searchBox.addEventListener("input", mostrarProductos);
    providerFilter.addEventListener("change", mostrarProductos);

    function convertirImgBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL("image/png");
          resolve(dataURL);
        };
        img.onerror = () => reject("No se pudo cargar la imagen");
        img.src = url;
      });
    }

    async function generarPDF() {
      const tienda = document.getElementById("storeName").value.trim();
      if (!tienda) {
        alert("Por favor, ingresa el nombre de la tienda.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try {
        const imgBase64 = await convertirImgBase64(logoUrl);
        doc.addImage(imgBase64, "PNG", 150, 10, 40, 20);
      } catch (e) {
        console.warn("No se pudo cargar el logo para el PDF", e);
      }

      doc.setFontSize(18);
      doc.text("Pedido de Tienda", 14, 20);
      doc.setFontSize(12);
      doc.text(Tienda: ${tienda}, 14, 28);
      doc.text(Fecha: ${new Date().toLocaleDateString()}, 14, 34);

      let y = 50;
      doc.text("Producto", 14, y);
      doc.text("Cantidad", 120, y);
      doc.text("Precio", 160, y);
      y += 10;

      let total = 0;

      productos.forEach((p, i) => {
        const input = document.getElementById(cant-${i});
        if (input && parseInt(input.value) > 0) {
          const cantidad = parseInt(input.value);
          doc.text(p.nombre, 14, y);
          doc.text(String(cantidad), 120, y);
          doc.text($${p.precio * cantidad}, 160, y);
          total += p.precio * cantidad;
          y += 10;
        }
      });

      y += 10;
      doc.text(TOTAL: $${total}, 14, y);

      doc.save(pedido-${tienda}-${new Date().toISOString().slice(0, 10)}.pdf);
    }

    cargarCatalogo();
  </script>
</body>
</html>
